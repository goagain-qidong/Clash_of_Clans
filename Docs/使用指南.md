# ?? 重构后的 DraggableMapScene 使用指南

## ?? **快速开始**

### **如何添加新的UI按钮？**

1. 在 `SceneUIController.h` 中添加回调类型和设置方法：
```cpp
// 在 SceneUIController.h 中
void setOnNewButtonClicked(const ButtonCallback& callback);
```

2. 在 `SceneUIController.cpp` 中创建按钮：
```cpp
// 在 setupMainButtons() 中
auto newButton = Button::create();
newButton->setTitleText("New");
newButton->setPosition(Vec2(x, y));
newButton->addClickEventListener([this](Ref*) {
    if (_onNewButtonClicked) _onNewButtonClicked();
});
this->addChild(newButton, 10);
```

3. 在 `DraggableMapScene.cpp` 中设置回调：
```cpp
// 在 setupCallbacks() 中
_uiController->setOnNewButtonClicked([this]() {
    // 处理点击事件
});
```

---

### **如何添加新的地图？**

1. 准备地图资源文件（例如 `map/Map4.png`）

2. 在 `DraggableMapScene::initializeManagers()` 中添加地图：
```cpp
_mapController->setMapNames({
    "map/Map1.png", 
    "map/Map2.png", 
    "map/Map3.png",
    "map/Map4.png"  // 新地图
});
```

3. 设置地图配置（可选）：
```cpp
// 在 MapController.cpp 的 init() 中
_mapConfigs["map/Map4.png"] = {
    1.3f,                    // scale
    Vec2(1400.0f, 2100.0f), // startPixel
    55.6f                   // tileSize
};
```

---

### **如何添加新的输入事件？**

1. 在 `InputController.h` 中定义回调类型：
```cpp
using NewInputCallback = std::function<void(参数类型)>;
```

2. 添加设置方法：
```cpp
void setOnNewInput(const NewInputCallback& callback);
```

3. 在 `InputController.cpp` 中处理事件：
```cpp
void InputController::handleNewInput(参数)
{
    if (_onNewInput)
    {
        _onNewInput(参数);
    }
}
```

4. 在 `DraggableMapScene.cpp` 中设置回调：
```cpp
_inputController->setOnNewInput([this](参数) {
    // 处理事件
});
```

---

## ?? **常见问题**

### **Q: 如何访问地图精灵？**
```cpp
// 在 DraggableMapScene 中
auto mapSprite = _mapController->getMapSprite();
```

### **Q: 如何访问网格地图？**
```cpp
// 在 DraggableMapScene 中
auto gridMap = _mapController->getGridMap();
```

### **Q: 如何显示提示信息？**
```cpp
// 在 DraggableMapScene 中
_uiController->showHint("提示信息");
```

### **Q: 如何显示确认按钮？**
```cpp
// 在 DraggableMapScene 中
Vec2 worldPos = ...; // 建筑的世界坐标
_uiController->showConfirmButtons(worldPos);
```

### **Q: 如何隐藏确认按钮？**
```cpp
_uiController->hideConfirmButtons();
```

### **Q: 如何缩放地图？**
```cpp
// 在 DraggableMapScene 中
float zoomFactor = 1.1f; // >1 放大，<1 缩小
Vec2 mousePos = ...; // 鼠标位置（世界坐标）
_mapController->zoomMap(zoomFactor, mousePos);
```

### **Q: 如何平移地图？**
```cpp
Vec2 delta = ...; // 移动距离
_mapController->moveMap(delta);
```

---

## ?? **管理器职责说明**

### **MapController**
**负责**：
- 地图加载和切换
- 地图缩放和平移
- 地图边界检查

**不负责**：
- UI创建和管理
- 输入事件处理
- 建筑管理

---

### **SceneUIController**
**负责**：
- 所有UI的创建和管理
- UI回调设置
- UI显示和隐藏

**不负责**：
- 地图操作
- 输入事件处理
- 游戏逻辑

---

### **InputController**
**负责**：
- 触摸事件处理
- 鼠标事件处理
- 键盘事件处理
- 输入优先级管理

**不负责**：
- UI创建
- 地图操作
- 游戏逻辑

---

### **DraggableMapScene**
**负责**：
- 管理器初始化
- 回调协调
- 游戏逻辑处理

**不负责**：
- 地图操作细节
- UI创建细节
- 输入事件细节

---

## ?? **最佳实践**

### **1. 单一职责原则**
每个管理器只负责一件事：
- 地图 → MapController
- UI → SceneUIController
- 输入 → InputController

### **2. 回调模式**
管理器通过回调与主控制器通信：
```cpp
_uiController->setOnShopClicked([this]() {
    // 主控制器处理逻辑
});
```

### **3. 避免直接访问**
不要在管理器之间直接调用，应通过主控制器协调：
```cpp
// ? 错误做法
_mapController->操作(_uiController->某个方法());

// ? 正确做法
_uiController->setOnSomeEvent([this]() {
    _mapController->操作();
});
```

---

## ?? **调试技巧**

### **如何查看某个功能在哪个管理器？**

| 功能 | 管理器 |
|------|--------|
| 地图加载、切换、缩放 | MapController |
| 按钮、列表、提示 | SceneUIController |
| 触摸、鼠标、键盘 | InputController |
| 建筑放置、升级 | BuildingManager |
| 场景协调、游戏逻辑 | DraggableMapScene |

### **如何添加日志？**
```cpp
CCLOG("Debug info: %s", info.c_str());
```

### **如何断点调试？**
在对应的管理器方法中添加断点：
- 地图问题 → MapController.cpp
- UI问题 → SceneUIController.cpp
- 输入问题 → InputController.cpp

---

祝你开发顺利！??
