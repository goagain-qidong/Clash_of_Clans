# 异步多人游戏测试指南

## ?? 系统概述

本游戏采用**异步多人游戏**模式，与部落冲突（Clash of Clans）相同：
- **不需要双方同时在线**
- **攻击的是对方基地的快照**
- **战斗结束后自动结算奖励**

---

## ?? 测试流程

### **Step 1: 创建两个账号**

1. **启动游戏** → 输入用户名 `player1` → 开始游戏
2. **建造一些建筑**（大本营、金矿、箭塔等）
3. **退出游戏**（关闭程序）
4. **再次启动游戏** → 输入用户名 `player2` → 开始游戏
5. **建造一些建筑**（布局可以和 player1 不同）

> ?? **提示**：每个账号的数据会自动保存到本地文件：
> - `gamedata_player1.json`
> - `gamedata_player2.json`

---

### **Step 2: 测试攻击功能**

1. **以 `player2` 身份登录**
2. **点击 "Attack!" 按钮**
3. **系统会自动加载 `player1` 的基地**
4. **进入战斗场景**，可以看到：
   - `player1` 的所有建筑布局
   - 3分钟倒计时
   - 星数显示（☆☆☆）
   - 摧毁百分比

5. **战斗结束后**：
   - 查看获得的星数
   - 查看掠夺的金币和圣水
   - 点击"返回主场景"

6. **返回后**：
   - 你的资源会自动增加
   - `player1` 的资源不会减少（因为只是本地测试，未连接服务器）

---

### **Step 3: 切换账号测试**

1. **退出游戏**
2. **重新登录为 `player1`**
3. **点击 "Attack!" 按钮**
4. **系统会加载 `player2` 的基地**
5. **测试攻击**

---

## ?? 当前实现的功能

### ? **已完成**
- [x] JSON 序列化/反序列化（建筑、资源）
- [x] 多账号本地测试
- [x] 加载敌方基地布局
- [x] 战斗计时器（3分钟）
- [x] 星数和摧毁百分比显示
- [x] 战斗结算（掠夺资源）
- [x] 自动保存/加载游戏状态

### ? **待实现**
- [ ] 士兵部署系统（点击地图部署士兵）
- [ ] 士兵移动和攻击AI
- [ ] 建筑被摧毁动画
- [ ] 实时计算摧毁百分比
- [ ] 服务器匹配系统（可选）
- [ ] 战斗回放功能（可选）

---

## ?? 未来服务器集成

当你准备好连接服务器时，只需取消注释 `DraggableMapScene::onBattleButtonClicked` 中的服务器代码：

```cpp
// 服务器匹配模式
if (SocketClient::getInstance().isConnected())
{
    SocketClient::getInstance().findMatch([this](bool success, const std::string& enemyUserId, const std::string& enemyData) {
        if (!success) {
            showBuildingHint("匹配失败，请稍后重试");
            return;
        }
        
        // 解析敌方基地数据
        auto enemyGameData = AccountGameData::fromJson(enemyData);
        
        // 进入战斗场景
        auto battleScene = BattleScene::createWithEnemyData(enemyGameData);
        Director::getInstance()->pushScene(TransitionFade::create(0.3f, battleScene));
    });
}
```

服务器只需实现两个接口：

1. **匹配请求** (`PACKET_FIND_MATCH`)
   - 输入：玩家ID、奖杯数
   - 输出：匹配到的对手ID + 对手基地数据（JSON）

2. **上传战斗结果** (`PACKET_ATTACK_RESULT`)
   - 输入：攻击者ID、防守者ID、星数、掠夺资源
   - 输出：更新双方的资源和奖杯

---

## ?? JSON 数据格式

### **玩家基地数据** (`gamedata_player1.json`)
```json
{
  "gold": 5000,
  "elixir": 3000,
  "darkElixir": 0,
  "gems": 100,
  "trophies": 1200,
  "townHallLevel": 3,
  "buildings": [
    {
      "name": "Town Hall Lv.3",
      "level": 3,
      "gridX": 10.0,
      "gridY": 15.0,
      "gridWidth": 5.0,
      "gridHeight": 5.0
    },
    {
      "name": "Gold Mine Lv.2",
      "level": 2,
      "gridX": 5.0,
      "gridY": 8.0,
      "gridWidth": 3.0,
      "gridHeight": 3.0
    }
  ]
}
```

---

## ?? 常见问题

### **Q: 点击 "Attack!" 没反应？**
**A**: 检查是否创建了第二个账号。系统需要至少两个账号才能进行本地测试。

### **Q: 显示"玩家 XXX 还没有建筑"？**
**A**: 第二个账号需要至少建造一个建筑。切换到该账号，建造一些建筑后再测试。

### **Q: 战斗场景一片空白？**
**A**: 检查控制台日志，确认建筑数据是否成功加载。可能是 JSON 文件损坏。

### **Q: 如何重置游戏数据？**
**A**: 删除 `gamedata_*.json` 文件，重新启动游戏即可。

---

## ?? 下一步开发建议

1. **实现士兵部署系统**
   - 在 BattleScene 底部添加士兵按钮
   - 点击士兵 → 点击地图 → 部署士兵

2. **实现战斗AI**
   - 士兵自动寻找最近的建筑
   - 攻击建筑直到摧毁
   - 建筑被摧毁后更新摧毁百分比

3. **添加服务器支持**
   - 实现匹配算法（根据奖杯数）
   - 存储战斗历史
   - 实现防守记录

4. **优化用户体验**
   - 添加匹配动画
   - 添加战斗音效
   - 添加胜利/失败特效

---

祝你测试顺利！如有问题请查看控制台日志（CCLOG）。
