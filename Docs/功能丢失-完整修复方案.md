# ?? 功能丢失问题 - 完整修复方案

## ? **丢失的功能清单**

### **1. 升级UI功能** - MISSING
- ? `onBuildingClicked()` - 点击建筑打开升级UI
- ? `hideUpgradeUI()` - 隐藏升级UI
- ? `closeUpgradeUI()` - 公开方法
- ? `cleanupUpgradeUI()` - 深度清理

### **2. 建筑拖动功能** - MISSING  
- ? `setupBuildingClickListener()` - 建筑点击监听器
- ? 长按拖动建筑移动位置

### **3. 场景完整初始化** - INCOMPLETE
- ? `initBuildingData()` - 建筑数据初始化
- ? HUD层显示
- ? 商店集成

### **4. 建筑管理器回调** - INCOMPLETE
- ? `onBuildingPlaced()` - 建筑放置成功回调
- ? 兵营训练完成回调

---

## ? **完整恢复方案**

### **文件1：DraggableMapScene.h** - 添加缺失的方法声明

```cpp
// 在 private 区域添加：

// ==================== 建筑回调（缺失的） ====================
void onBuildingPlaced(BaseBuilding* building);
void onBuildingClicked(BaseBuilding* building);
void onBuildingHint(const std::string& hint);

// ==================== 升级UI管理（缺失的） ====================
void showUpgradeUI(BaseBuilding* building);  // 内部使用
void hideUpgradeUI();                        // 统一隐藏方法
void cleanupUpgradeUI();                      // 深度清理

// ==================== 公开接口（缺失的） ====================
public:
void closeUpgradeUI();  // 外部调用接口
```

---

### **文件2：DraggableMapScene.cpp** - 恢复所有缺失的方法实现

#### **方法1：onBuildingPlaced - 建筑放置成功回调**

```cpp
void DraggableMapScene::onBuildingPlaced(BaseBuilding* building)
{
    if (!building)
        return;

    CCLOG("Building placed: %s", building->getDisplayName().c_str());
    
    // 检查是否为兵营建筑
    if (building->getBuildingType() == BuildingType::kArmy)
    {
        auto barracks = dynamic_cast<ArmyBuilding*>(building);
        if (barracks)
        {
            barracks->setOnTrainingComplete([this, barracks](Unit* unit) {
                if (!unit) return;
                
                Vec2 barracksWorldPos = barracks->getParent()->convertToWorldSpace(barracks->getPosition());
                Vec2 spawnPos = barracksWorldPos;
                spawnPos.x += barracks->getContentSize().width * barracks->getScale() + 20;
                
                Vec2 spawnLocalPos = _mapController->getMapSprite()->convertToNodeSpace(spawnPos);
                unit->setPosition(spawnLocalPos);
                
                _mapController->getMapSprite()->addChild(unit, 100);
                unit->PlayAnimation(UnitAction::kIdle, UnitDirection::kRight);
                
                CCLOG("?? Unit training complete!");
                _uiController->showHint("士兵训练完成！");
            });
        }
    }
    
    _uiController->hideConfirmButtons();
}
```

#### **方法2：onBuildingClicked - 打开升级UI**

```cpp
void DraggableMapScene::onBuildingClicked(BaseBuilding* building)
{
    if (!building)
        return;
    
    CCLOG("Building clicked: %s", building->getDisplayName().c_str());
    showUpgradeUI(building);
}

void DraggableMapScene::showUpgradeUI(BaseBuilding* building)
{
    hideUpgradeUI();
    
    auto upgradeUI = BuildingUpgradeUI::create(building);
    if (upgradeUI)
    {
        upgradeUI->setPositionNearBuilding(building);
        
        upgradeUI->setUpgradeCallback([this, building](bool success, int newLevel) {
            if (success)
            {
                _uiController->showHint(
                    StringUtils::format("%s 升级到 %d 级！", building->getDisplayName().c_str(), newLevel));
            }
            else
            {
                _uiController->showHint("资源不足，无法升级！");
            }
        });
        
        upgradeUI->setCloseCallback([this]() {
            _currentUpgradeUI = nullptr;
        });
        
        this->addChild(upgradeUI, 1000);
        upgradeUI->show();
        _currentUpgradeUI = upgradeUI;
    }
}
```

#### **方法3：hideUpgradeUI - 隐藏升级UI**

```cpp
void DraggableMapScene::hideUpgradeUI()
{
    if (!_currentUpgradeUI)
        return;
    
    auto upgradeUI = dynamic_cast<BuildingUpgradeUI*>(_currentUpgradeUI);
    if (upgradeUI)
    {
        upgradeUI->hide();
    }
    else
    {
        _currentUpgradeUI->removeFromParent();
    }
    _currentUpgradeUI = nullptr;
}

void DraggableMapScene::closeUpgradeUI()
{
    hideUpgradeUI();
}

void DraggableMapScene::cleanupUpgradeUI()
{
    if (_currentUpgradeUI)
    {
        if (_currentUpgradeUI->getParent() == this)
        {
            _currentUpgradeUI->removeFromParent();
        }
        _currentUpgradeUI = nullptr;
    }
}
```

#### **方法4：onBuildingHint - 显示提示**

```cpp
void DraggableMapScene::onBuildingHint(const std::string& hint)
{
    _uiController->showHint(hint);
}
```

---

### **文件3：setupCallbacks() - 完善建筑管理器回调**

在 `DraggableMapScene::setupCallbacks()` 中添加：

```cpp
// ==================== 建筑管理器回调（之前缺失的） ====================
_buildingManager->setOnBuildingPlaced([this](BaseBuilding* building) {
    onBuildingPlaced(building);
});

_buildingManager->setOnBuildingClicked([this](BaseBuilding* building) {
    onBuildingClicked(building);
});

_buildingManager->setOnHint([this](const std::string& hint) {
    onBuildingHint(hint);
});
```

---

## ?? **完整修复步骤**

### **Step 1: 更新 DraggableMapScene.h**

添加所有缺失的方法声明（见上文）

### **Step 2: 更新 DraggableMapScene.cpp**

1. 添加所有缺失的方法实现
2. 在 `setupCallbacks()` 中设置建筑管理器回调
3. 在 `onTouchBegan()` 中添加升级UI优先级检查

### **Step 3: 确保 BuildingManager 正确调用回调**

在 `BuildingManager::setupBuildingClickListener()` 中：

```cpp
listener->onTouchEnded = [this, building](Touch* touch, Event* event) {
    if (_isMovingBuilding && _movingBuilding == building)
    {
        onBuildingTouchEnded(touch->getLocation(), building);
    }
    else if (!_isBuildingMode && !_isMovingBuilding && !hasMoved)
    {
        // ? 调用回调触发场景的 onBuildingClicked
        if (_onBuildingClicked)
        {
            _onBuildingClicked(building);
        }
    }
    
    hasMoved = false;
};
```

---

## ?? **验证清单**

修复后需要验证的功能：

- [ ] **点击建筑** → 显示升级UI ?
- [ ] **点击升级按钮** → 扣除资源，升级成功 ?
- [ ] **点击UI外** → 隐藏升级UI ?
- [ ] **拖动建筑** → 进入移动模式 ?
- [ ] **释放建筑** → 移动成功或恢复 ?
- [ ] **建造建筑** → 显示确认按钮 ?
- [ ] **兵营训练** → 生成士兵到地图 ?

---

## ?? **关键要点**

### **回调链完整流程**

```
BuildingManager::setupBuildingClickListener()
    ↓ (用户点击建筑)
_onBuildingClicked(building)
    ↓
DraggableMapScene::onBuildingClicked(building)
    ↓
showUpgradeUI(building)
    ↓
BuildingUpgradeUI::create(building)
    ↓
显示UI，等待用户交互
```

### **为什么功能丢失？**

1. **方法缺失**：`onBuildingClicked()` 等方法没有在新代码中实现
2. **回调未设置**：`setupCallbacks()` 中没有设置建筑管理器回调
3. **接口不完整**：`BuildingManager` 的回调没有被正确调用

---

## ? **修复后的效果**

- ? 所有原有功能恢复
- ? 代码结构清晰（MVC模式）
- ? 回调链完整
- ? 易于维护和扩展

---

**推荐操作**：

1. 按照上述方案逐步修复
2. 每修复一个功能就编译测试
3. 验证所有功能正常后再继续

祝你修复顺利！??
