# 设置面板功能实现报告

## 概述
已成功实现完整的游戏设置面板系统，包含以下功能：
- ?? 齿轮图标设置按钮
- ?? 账号切换功能
- ?? 音量调节（音乐和音效）
- ?? 退出登录
- ?? 资源全满模式（测试功能）
- ?? GridDev开发模式

## 新增文件

### 1. `Classes/UI/SettingsPanel.h`
设置面板头文件，包含所有设置功能的接口定义。

### 2. `Classes/UI/SettingsPanel.cpp`
设置面板实现文件，实现了：
- 面板UI布局和动画
- 音量滑块控制（保存到UserDefault）
- 账号列表显示和切换
- 资源全满功能
- GridDev模式切换（显示/隐藏网格和MapConfigManager编辑器）

## 修改的文件

### 1. `Classes/Managers/SceneUIController.h`
添加：
- 设置按钮成员变量
- GridMap和MapConfigManager引用
- 账号切换和登出回调接口

### 2. `Classes/Managers/SceneUIController.cpp`
添加：
- 设置按钮（齿轮图标?）在右上角
- `onSettingsClicked()` 方法创建和显示设置面板
- 设置GridMap和MapConfigManager的方法

### 3. `Classes/Scenes/DraggableMapScene.h`
添加：
- MapConfigManager管理器成员
- 账号切换和登出回调方法

### 4. `Classes/Scenes/DraggableMapScene.cpp`
添加：
- MapConfigManager初始化
- 将GridMap和MapConfigManager连接到UIController
- `onAccountSwitched()` - 账号切换后重新加载游戏状态
- `onLogout()` - 退出登录功能

## 功能说明

### 设置按钮
- 位置：右上角，Map按钮下方
- 图标：齿轮符号 ?
- 点击后弹出设置面板

### 设置面板布局
```
┌────────────────────────────────────┐
│  ? 游戏设置                    X  │
├────────────────────────────────────┤
│  ?? 音乐音量:  [TTTTTTT]  100%   │
│  ?? 音效音量:  [TTTTTTT]  100%   │
├────────────────────────────────────┤
│  ?? 切换账号                      │
│  ?? 退出登录                      │
│  ?? 资源全满 (测试)               │
│  ?? GridDev 模式                   │
└────────────────────────────────────┘
```

### 音量控制
- 音乐和音效分别有独立的滑块
- 范围：0-100%
- 自动保存到UserDefault
- 实时应用到AudioEngine

### 账号切换
- 点击"切换账号"显示所有已注册账号列表
- 当前账号高亮显示
- 点击其他账号切换并重新加载游戏状态

### 退出登录
- 保存当前游戏状态
- 调用AccountManager::signOut()
- 关闭游戏（未来可改为返回登录界面）

### 资源全满模式
- 测试功能：一键添加大量资源
- 金币 +100000
- 圣水 +100000
- 黑暗圣水 +10000
- 宝石 +1000
- 显示确认提示

### GridDev 开发模式
- 显示/隐藏网格
- 打开MapConfigManager编辑器UI
- 可以调整地图scale、startPixel、tileSize等参数
- 实时预览和保存配置

## 使用方法

1. **打开设置**：点击右上角的?图标

2. **调节音量**：拖动滑块调整音乐或音效音量

3. **切换账号**：
   - 点击"切换账号"按钮
   - 从列表中选择要切换的账号
   - 游戏自动加载该账号的数据

4. **退出登录**：点击"退出登录"按钮

5. **资源全满**：点击"资源全满(测试)"按钮，瞬间获得大量资源

6. **GridDev模式**：
   - 点击"GridDev模式"按钮
   - 网格将显示在地图上
   - MapConfigManager编辑器UI出现
   - 可以调整各种地图参数
   - 点击"关闭GridDev"按钮退出模式

## 技术细节

### 依赖关系
```
DraggableMapScene
    ↓
SceneUIController ← SettingsPanel
    ↓                    ↓
GridMap           MapConfigManager
```

### 回调链
```
SettingsPanel::onAccountSwitchClicked()
    → showAccountList()
    → AccountManager::switchAccount()
    → _onAccountSwitched callback
    → DraggableMapScene::onAccountSwitched()
    → BuildingManager::loadCurrentAccountState()
```

### 数据持久化
- 音量设置：存储在UserDefault中
  - Key: "MusicVolume" (0-100)
  - Key: "SFXVolume" (0-100)
- 地图配置：存储在map_configs.json文件中
- 游戏数据：通过AccountManager管理

## 注意事项

1. **编译问题**：
   - 确保SettingsPanel.h/cpp在项目中正确添加
   - 可能需要清理并重新编译项目
   - Include路径使用相对路径 `#include "../UI/SettingsPanel.h"`

2. **LoginScene**：
   - 当前退出登录直接结束游戏
   - 如果有LoginScene，可以将`Director::getInstance()->end()`改为跳转到登录场景

3. **滑块资源**：
   - 需要ui/slider_back.png
   - 需要ui/slider_thumb.png
   - 需要ui/slider_progress.png
   - 如果没有这些资源，滑块可能显示异常

4. **GridDev模式**：
   - 只在开发阶段使用
   - 可以通过宏定义控制是否显示该按钮
   - 发布版本建议隐藏

## 未来改进建议

1. **登录系统集成**：
   - 创建完整的LoginScene
   - 退出登录后跳转到登录界面而不是关闭游戏

2. **更多设置选项**：
   - 语言切换
   - 画质设置
   - 通知开关
   - 帮助和教程

3. **UI优化**：
   - 添加滑块资源图片
   - 更好的动画效果
   - 响应式布局

4. **权限控制**：
   - GridDev模式仅在DEBUG模式下可用
   - 资源全满功能仅开发者可用

## 测试清单

- [ ] 点击设置按钮打开面板
- [ ] 音量滑块正常工作
- [ ] 音量设置保存并在重启后恢复
- [ ] 账号列表正确显示
- [ ] 切换账号成功并加载对应数据
- [ ] 退出登录功能正常
- [ ] 资源全满功能正常
- [ ] GridDev模式切换正常
- [ ] 网格显示/隐藏正常
- [ ] MapConfigManager编辑器正常工作

## 完成时间
2025年12月8日

## 版本
v1.0

---

**注意**：本功能已完整实现，建议进行完整测试后再集成到主分支。
