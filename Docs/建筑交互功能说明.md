# ?? 建筑交互功能说明

## ?? **用户操作指南**

### **1. 单击建筑 - 打开升级UI**
```
轻点建筑 → 显示升级UI → 查看属性/升级
```
- **触发条件**：点击后不移动（移动距离 < 10像素）
- **效果**：显示建筑升级界面

---

### **2. 长按拖动 - 移动建筑位置**
```
长按建筑 → 拖动30像素 → 进入移动模式 → 释放确认
```
- **触发条件**：拖动距离 > 30像素
- **效果**：
  - ? 有效位置：绿色网格 → 建筑移动成功
  - ? 无效位置：红色网格 → 恢复原位置

---

### **3. 放置新建筑 - 确认流程**
```
选择建筑 → 点击地图 → 拖动调整 → 释放 → 点击?/?
```
- **确认按钮**：绿色背景 + ? 符号
- **取消按钮**：红色背景 + ? 符号

---

## ?? **开发者参考**

### **触摸优先级（从高到低）**
```
1. 升级UI         (最高)
2. 建筑移动模式
3. 建筑建造模式
4. 地图平移       (最低)
```

### **移动距离阈值**
```cpp
10px  → 标记为已移动（不触发点击）
30px  → 进入建筑移动模式
```

### **关键方法**
```cpp
// BuildingManager
setupBuildingClickListener(building);  // 添加监听器
startMovingBuilding(building);         // 进入移动模式
confirmBuildingMove();                 // 确认移动
cancelMovingBuilding();                // 取消移动

// DraggableMapScene
onTouchBegan();   // 处理触摸开始
onTouchMoved();   // 处理触摸移动
onTouchEnded();   // 处理触摸结束
```

---

## ?? **调试技巧**

### **如何查看触摸状态**
```cpp
// 在 onTouchMoved 中添加日志
float distance = currentPos.distance(touchBeganPos);
CCLOG("Move distance: %.2f", distance);

// 查看是否进入移动模式
if (_buildingManager->isMovingBuilding()) {
    CCLOG("? In moving mode");
}
```

### **常见问题排查**
| 问题 | 可能原因 | 解决方法 |
|------|---------|---------|
| 单击无反应 | hasMoved 未重置 | 检查 onTouchEnded |
| 拖动立即触发 | 阈值太小 | 增加到 30px |
| 按钮显示 "?" | 编码问题 | 使用 UTF-8 编码 |

---

## ? **修复清单**

- [x] 建筑拖动功能恢复
- [x] 确认/取消按钮显示修复
- [x] 触摸优先级调整
- [x] 移动距离阈值优化
- [x] 编译通过，零错误

---

**快速测试**：
1. 单击建筑 → 应该打开升级UI ?
2. 拖动建筑 → 应该进入移动模式 ?
3. 放置建筑 → 应该显示 ? 和 ? 按钮 ?
