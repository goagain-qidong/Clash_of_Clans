# PVP 联网对战测试说明

## ?? 修复内容

### 1. **服务器连接问题**
- ? 修正端口配置：统一使用端口 `8888`
- ? 启用自动连接：场景启动时自动连接服务器
- ? 自动登录：连接成功后自动使用当前账号登录
- ? 自动上传地图：登录后立即上传基地数据到服务器

### 2. **PVP 功能完善**
- ? 添加 PVP 按钮到玩家列表
- ? 修复防守方地图加载逻辑
- ? 实现攻击者和防守者的角色区分

### 3. **UI 改进**
- ? 商店界面添加返回按钮图标支持 (`icon/return_button.png`)

---

## ?? 测试步骤

### 准备工作
1. **启动服务器**
   - 运行 `Server.exe`（位于服务器项目构建目录）
   - 确认显示：`Server started on port 8888`

2. **启动多个客户端**
   - 打开第一个客户端（玩家A）
   - 使用不同账号登录第二个客户端（玩家B）

### PVP 对战测试

#### 玩家A（攻击者）
1. 点击主场景的 **"Attack!"** 按钮
2. 在弹出的军队选择界面，选择兵种并点击 **"确认"**
3. 等待玩家列表加载（会显示在线的其他玩家）
4. 在玩家列表中选择玩家B，点击 **"PVP"** 按钮（不是"攻击！"按钮）
5. 如果连接成功，会自动进入战斗场景
6. 在战斗场景中部署士兵
7. 观察对方（玩家B）的实时防御

#### 玩家B（防守者）
1. 在主场景等待
2. 当玩家A发起PVP挑战时，会自动切换到战斗场景
3. 场景顶部显示：**"Defending against attacker..."**
4. **无法手动部署士兵**（防守方被动观看）
5. 实时看到攻击者部署的士兵和战斗过程

---

## ?? 调试信息

### 客户端日志
连接成功时会输出：
```
[Socket] ?? 正在连接到服务器 127.0.0.1:8888...
[Socket] ? 连接成功！
[Socket] ?? Sent login: <UserID>
[Socket] ?? Uploaded map data (size: <N> bytes)
```

PVP请求时输出：
```
?? Requesting PVP with: <TargetUserID>
```

### 服务器日志
玩家连接时：
```
[Connect] New client: <Socket>
[Login] User: <UserID> (Trophies: <N>)
[Map] Saved for: <UserID> (Size: <N>)
```

PVP匹配时：
```
[PVP] Started: <AttackerID> vs <DefenderID>
```

---

## ? 常见问题

### 问题1：连接失败
**原因：**服务器未启动或端口被占用  
**解决：**
- 确认服务器正在运行
- 检查防火墙是否阻止端口 8888
- 尝试使用管理员权限运行服务器

### 问题2：无法看到其他玩家
**原因：**
- 只有一个客户端连接
- 其他玩家未登录不同账号

**解决：**
- 使用不同账号启动至少两个客户端
- 确认两个客户端都显示连接成功

### 问题3：PVP失败提示 "FAIL|NO_MAP"
**原因：**对方未上传地图数据  
**解决：**
- 确保双方都已成功登录
- 等待几秒后重试（确保地图上传完成）

### 问题4：防守者可以下兵
**原因：**客户端代码未正确设置防守模式  
**解决：**
- 确认 `BattleManager` 中 `_isAttacker` 标志正确
- 重新编译客户端

---

## ?? 功能对比

| 功能 | 传统攻击（Attack按钮） | PVP对战（PVP按钮） |
|------|----------------------|------------------|
| 联网要求 | ? 离线（本地数据） | ? 在线（实时同步） |
| 对方状态 | 静态（快照） | 动态（实时观看） |
| 数据来源 | 本地存储 | 服务器转发 |
| 对方反馈 | 无 | 实时观战 |
| 胜负判定 | 单方面计算 | 双方同步 |

---

## ?? 下一步优化

1. **添加观战功能**：其他玩家可以观看正在进行的PVP对战
2. **PVP匹配系统**：自动匹配实力相近的对手
3. **实时聊天**：对战中的简单表情/文字交流
4. **战斗回放**：保存PVP录像供事后观看
5. **排行榜**：展示PVP战绩

---

## ?? 技术要点

### 网络通信流程
1. 客户端 → 服务器：`PACKET_PVP_REQUEST(targetId)`
2. 服务器验证：目标在线、未在战斗中、有地图数据
3. 服务器 → 攻击者：`PACKET_PVP_START(ATTACK|targetId|mapData)`
4. 服务器 → 防守者：`PACKET_PVP_START(DEFEND|attackerId)`
5. 攻击者操作 → 服务器：`PACKET_PVP_ACTION(unitType|x|y)`
6. 服务器 → 防守者：转发操作数据
7. 任一方结束 → 服务器：`PACKET_PVP_END`
8. 服务器 → 双方：广播结束通知

### 关键代码位置
- **客户端连接**：`DraggableMapScene::connectToServer()`
- **PVP请求**：`PlayerListLayer::createPlayerItem()` → PVP按钮回调
- **服务器处理**：`Server::handlePvpRequest()`
- **战斗场景**：`BattleScene::setPvpMode()`
- **UI回调**：`SceneUIController::init()` → `setOnPvpStart`

---

## ? 验证清单

- [ ] 服务器成功启动（显示端口8888）
- [ ] 客户端A连接成功并登录
- [ ] 客户端B连接成功并登录
- [ ] 客户端A可以看到客户端B在玩家列表中
- [ ] 点击PVP按钮后，双方都进入战斗场景
- [ ] 攻击者可以部署士兵
- [ ] 防守者无法部署士兵（按钮不可见）
- [ ] 防守者能实时看到攻击者的操作
- [ ] 战斗结束后双方都能返回主场景

---

**祝测试顺利！** ??
